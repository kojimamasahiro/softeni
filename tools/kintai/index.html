<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>å‹¤æ€ ãƒ„ãƒ¼ãƒ«ï¼ˆç·¨é›†ãƒ»å‰Šé™¤å¯¾å¿œï¼‰</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2em;
        }

        button {
            margin: 0.3em;
            padding: 0.5em 1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 0.5em;
            text-align: center;
            vertical-align: top;
        }

        input.time-edit {
            width: 60px;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>å‹¤æ€ ãƒ„ãƒ¼ãƒ«ï¼ˆç·¨é›†ãƒ»å‰Šé™¤å¯¾å¿œï¼‰</h1>
    <div>
        <button onclick="record('in')">å‡ºå‹¤</button>
        <button onclick="record('out')">é€€å‹¤</button>
        <button onclick="record('breakStart')">å¤–å‡º</button>
        <button onclick="record('breakEnd')">æˆ»ã‚Š</button>
        <button onclick="downloadCSV()">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="summary" style="margin-top:1.5em; font-weight:bold; font-size:1.1em;"></div>

    <table id="logTable">
        <thead>
            <tr>
                <th>æ—¥ä»˜</th>
                <th>å‡ºå‹¤</th>
                <th>é€€å‹¤</th>
                <th>ä¸­æŠœã‘</th>
                <th>å‹¤å‹™æ™‚é–“</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <script>
        const KEY = 'kintaiData';
        const BASE_HOUR = 5;

        function getWorkDate(now) {
            const temp = new Date(now);
            if (now.getHours() < BASE_HOUR) {
                temp.setDate(now.getDate() - 1);
            }
            return temp.toLocaleDateString('ja-JP');
        }

        function toHHMM(dt) {
            let h = dt.getHours(), m = dt.getMinutes();
            if (h < BASE_HOUR) h += 24;
            return `${('0' + h).slice(-2)}:${('0' + m).slice(-2)}`;
        }

        function toDateObj(str) {
            const [h, m] = str.split(':').map(Number);
            const date = new Date();
            if (h >= 24) {
                date.setDate(date.getDate() + 1);
                date.setHours(h - 24, m, 0);
            } else {
                date.setHours(h, m, 0);
            }
            return date;
        }

        function calcDuration(start, end, breaks = []) {
            const startTime = toDateObj(start);
            const endTime = toDateObj(end);
            let total = (endTime - startTime) / 1000 / 60;
            for (const b of breaks) {
                if (b.start && b.end) {
                    total -= (toDateObj(b.end) - toDateObj(b.start)) / 1000 / 60;
                }
            }
            if (total < 0) return 'ä¸æ˜';
            const h = Math.floor(total / 60), m = total % 60;
            return `${h}æ™‚é–“${m.toFixed(0)}åˆ†`;
        }

        function record(type) {
            const now = new Date();
            const time = toHHMM(now);
            const date = getWorkDate(now);
            let data = JSON.parse(localStorage.getItem(KEY) || '{}');
            data[date] = data[date] || { in: '', out: '', breaks: [] };

            if (type === 'in') {
                if (data[date].in) {
                    alert('ã™ã§ã«å‡ºå‹¤æ¸ˆã¿ã§ã™ã€‚');
                    return;
                }
                data[date].in = time;
            } else if (type === 'out') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (lastBreak && !lastBreak.end) {
                    lastBreak.end = time;
                    alert('å¤–å‡ºä¸­ã ã£ãŸãŸã‚ã€æˆ»ã‚Š â†’ é€€å‹¤ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸã€‚');
                }
                data[date].out = time;
            } else if (type === 'breakStart') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (!lastBreak || lastBreak.end) {
                    data[date].breaks.push({ start: time, end: '' });
                } else {
                    alert('ã™ã§ã«å¤–å‡ºä¸­ã§ã™ã€‚æˆ»ã‚Šã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚');
                }
            } else if (type === 'breakEnd') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (lastBreak && !lastBreak.end) {
                    lastBreak.end = time;
                } else {
                    alert('å¤–å‡ºè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            }

            localStorage.setItem(KEY, JSON.stringify(data));
            render();
            // ãƒˆãƒ¼ã‚¿ãƒ«å‹¤å‹™æ™‚é–“ãƒ»æ—¥æ•°ãƒ»å¹³å‡æ™‚é–“
            let totalMinutes = 0;
            let workDays = 0;

            Object.values(data).forEach(row => {
                if (row.in) {
                    workDays++;
                    const assumedOut = row.out || toHHMM(new Date());
                    const minutes = (toDateObj(assumedOut) - toDateObj(row.in)) / 1000 / 60;
                    const breakMinutes = row.breaks?.reduce((sum, b) => {
                        if (b.start && b.end) {
                            sum += (toDateObj(b.end) - toDateObj(b.start)) / 1000 / 60;
                        }
                        return sum;
                    }, 0) || 0;
                    totalMinutes += minutes - breakMinutes;
                }
            });

            const totalHours = Math.floor(totalMinutes / 60);
            const totalRemain = Math.round(totalMinutes % 60);
            const avgMinutes = workDays ? totalMinutes / workDays : 0;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgRemain = Math.round(avgMinutes % 60);

            document.getElementById('summary').innerHTML = `
  ğŸŸ¦ ãƒˆãƒ¼ã‚¿ãƒ«å‹¤å‹™æ™‚é–“ï¼š${totalHours}æ™‚é–“${totalRemain}åˆ†<br>
  ğŸŸ© å‹¤å‹™æ—¥æ•°ï¼š${workDays}æ—¥<br>
  ğŸŸ¨ å¹³å‡åŠ´åƒæ™‚é–“ï¼š${avgHours}æ™‚é–“${avgRemain}åˆ†/æ—¥
`;
        }

        function makeEditableSpan(value, callback) {
            const span = document.createElement('span');
            span.textContent = value;
            span.style.cursor = 'pointer';
            span.onclick = () => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.className = 'time-edit';
                input.onblur = input.onchange = () => {
                    const newValue = input.value.trim();
                    if (newValue === '') {
                        callback(null); // å‰Šé™¤å‡¦ç†
                    } else if (/^\d{1,2}:\d{2}$/.test(newValue)) {
                        callback(newValue);
                    } else {
                        alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆä¾‹ï¼š25:30ï¼‰');
                    }
                };
                span.replaceWith(input);
                input.focus();
            };
            return span;
        }

        function render() {
            const data = JSON.parse(localStorage.getItem(KEY) || '{}');
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';

            Object.keys(data).sort().reverse().forEach(date => {
                const row = data[date];
                const tr = document.createElement('tr');

                const tdDate = document.createElement('td');
                tdDate.textContent = date;
                tr.appendChild(tdDate);

                const tdIn = document.createElement('td');
                tdIn.appendChild(makeEditableSpan(row.in || '', val => {
                    row.in = val || '';
                    localStorage.setItem(KEY, JSON.stringify(data));
                    render();
                }));
                tr.appendChild(tdIn);

                const tdOut = document.createElement('td');
                tdOut.appendChild(makeEditableSpan(row.out || '', val => {
                    row.out = val || '';
                    localStorage.setItem(KEY, JSON.stringify(data));
                    render();
                }));
                tr.appendChild(tdOut);

                const tdBreaks = document.createElement('td');
                row.breaks.forEach((b, i) => {
                    const div = document.createElement('div');
                    div.textContent = `å¤–å‡º${i + 1}ï¼š`;

                    div.appendChild(makeEditableSpan(b.start || '', val => {
                        b.start = val || '';
                        if (!b.start && !b.end) row.breaks.splice(i, 1);
                        localStorage.setItem(KEY, JSON.stringify(data));
                        render();
                    }));

                    div.append(' ï½ ');

                    div.appendChild(makeEditableSpan(b.end || '', val => {
                        b.end = val || '';
                        if (!b.start && !b.end) row.breaks.splice(i, 1);
                        localStorage.setItem(KEY, JSON.stringify(data));
                        render();
                    }));

                    tdBreaks.appendChild(div);
                });
                tr.appendChild(tdBreaks);

                const tdWork = document.createElement('td');
                let workTime = '';
                if (row.in) {
                    const assumedOut = row.out || toHHMM(new Date());
                    workTime = calcDuration(row.in, assumedOut, row.breaks);
                    if (!row.out) workTime += 'ï¼ˆæš«å®šï¼‰';
                }
                tdWork.textContent = workTime;
                tr.appendChild(tdWork);

                tbody.appendChild(tr);
            });
        }

        function downloadCSV() {
            const data = JSON.parse(localStorage.getItem(KEY) || '{}');
            let csv = 'æ—¥ä»˜,å‡ºå‹¤,é€€å‹¤,ä¸­æŠœã‘,å‹¤å‹™æ™‚é–“\n';
            Object.keys(data).sort().forEach(date => {
                const row = data[date];
                const breaks = row.breaks.map(b => `${b.start || ''}ï½${b.end || ''}`).join(' / ');
                const workTime = (row.in && row.out) ? calcDuration(row.in, row.out, row.breaks) : '';
                csv += `${date},${row.in || ''},${row.out || ''},"${breaks}","${workTime}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'kintai.csv';
            a.click();
        }

        render();

        setInterval(render, 60000);
    </script>
</body>

</html>