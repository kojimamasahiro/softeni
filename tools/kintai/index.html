<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>勤怠ツール（編集・削除対応）</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2em;
        }

        button {
            margin: 0.3em;
            padding: 0.5em 1em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 0.5em;
            text-align: center;
            vertical-align: top;
        }

        input.time-edit {
            width: 60px;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>勤怠ツール（編集・削除対応）</h1>
    <div>
        <button onclick="record('in')">出勤</button>
        <button onclick="record('out')">退勤</button>
        <button onclick="record('breakStart')">外出</button>
        <button onclick="record('breakEnd')">戻り</button>
        <button onclick="downloadCSV()">CSVダウンロード</button>
    </div>

    <table id="logTable">
        <thead>
            <tr>
                <th>日付</th>
                <th>出勤</th>
                <th>退勤</th>
                <th>中抜け</th>
                <th>勤務時間</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const KEY = 'kintaiData';
        const BASE_HOUR = 5;

        function getWorkDate(now) {
            const temp = new Date(now);
            if (now.getHours() < BASE_HOUR) {
                temp.setDate(now.getDate() - 1);
            }
            return temp.toLocaleDateString('ja-JP');
        }

        function toHHMM(dt) {
            let h = dt.getHours(), m = dt.getMinutes();
            if (h < BASE_HOUR) h += 24;
            return `${('0' + h).slice(-2)}:${('0' + m).slice(-2)}`;
        }

        function toDateObj(str) {
            const [h, m] = str.split(':').map(Number);
            const date = new Date();
            if (h >= 24) {
                date.setDate(date.getDate() + 1);
                date.setHours(h - 24, m, 0);
            } else {
                date.setHours(h, m, 0);
            }
            return date;
        }

        function calcDuration(start, end, breaks = []) {
            const startTime = toDateObj(start);
            const endTime = toDateObj(end);
            let total = (endTime - startTime) / 1000 / 60;
            for (const b of breaks) {
                if (b.start && b.end) {
                    total -= (toDateObj(b.end) - toDateObj(b.start)) / 1000 / 60;
                }
            }
            if (total < 0) return '不明';
            const h = Math.floor(total / 60), m = total % 60;
            return `${h}時間${m.toFixed(0)}分`;
        }

        function record(type) {
            const now = new Date();
            const time = toHHMM(now);
            const date = getWorkDate(now);
            let data = JSON.parse(localStorage.getItem(KEY) || '{}');
            data[date] = data[date] || { in: '', out: '', breaks: [] };

            if (type === 'in') {
                if (data[date].in) {
                    alert('すでに出勤済みです。');
                    return;
                }
                data[date].in = time;
            } else if (type === 'out') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (lastBreak && !lastBreak.end) {
                    lastBreak.end = time;
                    alert('外出中だったため、戻り → 退勤として記録しました。');
                }
                data[date].out = time;
            } else if (type === 'breakStart') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (!lastBreak || lastBreak.end) {
                    data[date].breaks.push({ start: time, end: '' });
                } else {
                    alert('すでに外出中です。戻りを記録してください。');
                }
            } else if (type === 'breakEnd') {
                const lastBreak = data[date].breaks[data[date].breaks.length - 1];
                if (lastBreak && !lastBreak.end) {
                    lastBreak.end = time;
                } else {
                    alert('外出記録がありません。');
                }
            }

            localStorage.setItem(KEY, JSON.stringify(data));
            render();
        }

        function makeEditableSpan(value, callback) {
            const span = document.createElement('span');
            span.textContent = value;
            span.style.cursor = 'pointer';
            span.onclick = () => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.className = 'time-edit';
                input.onblur = input.onchange = () => {
                    const newValue = input.value.trim();
                    if (newValue === '') {
                        callback(null); // 削除処理
                    } else if (/^\d{1,2}:\d{2}$/.test(newValue)) {
                        callback(newValue);
                    } else {
                        alert('形式が正しくありません（例：25:30）');
                    }
                };
                span.replaceWith(input);
                input.focus();
            };
            return span;
        }

        function render() {
            const data = JSON.parse(localStorage.getItem(KEY) || '{}');
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';

            Object.keys(data).sort().reverse().forEach(date => {
                const row = data[date];
                const tr = document.createElement('tr');

                const tdDate = document.createElement('td');
                tdDate.textContent = date;
                tr.appendChild(tdDate);

                const tdIn = document.createElement('td');
                tdIn.appendChild(makeEditableSpan(row.in || '', val => {
                    row.in = val || '';
                    localStorage.setItem(KEY, JSON.stringify(data));
                    render();
                }));
                tr.appendChild(tdIn);

                const tdOut = document.createElement('td');
                tdOut.appendChild(makeEditableSpan(row.out || '', val => {
                    row.out = val || '';
                    localStorage.setItem(KEY, JSON.stringify(data));
                    render();
                }));
                tr.appendChild(tdOut);

                const tdBreaks = document.createElement('td');
                row.breaks.forEach((b, i) => {
                    const div = document.createElement('div');
                    div.textContent = `外出${i + 1}：`;

                    div.appendChild(makeEditableSpan(b.start || '', val => {
                        b.start = val || '';
                        if (!b.start && !b.end) row.breaks.splice(i, 1); // 両方空なら削除
                        localStorage.setItem(KEY, JSON.stringify(data));
                        render();
                    }));

                    div.append(' ～ ');

                    div.appendChild(makeEditableSpan(b.end || '', val => {
                        b.end = val || '';
                        if (!b.start && !b.end) row.breaks.splice(i, 1);
                        localStorage.setItem(KEY, JSON.stringify(data));
                        render();
                    }));

                    tdBreaks.appendChild(div);
                });
                tr.appendChild(tdBreaks);

                const tdWork = document.createElement('td');
                const workTime = (row.in && row.out) ? calcDuration(row.in, row.out, row.breaks) : '';
                tdWork.textContent = workTime;
                tr.appendChild(tdWork);

                tbody.appendChild(tr);
            });
        }

        function downloadCSV() {
            const data = JSON.parse(localStorage.getItem(KEY) || '{}');
            let csv = '日付,出勤,退勤,中抜け,勤務時間\n';
            Object.keys(data).sort().forEach(date => {
                const row = data[date];
                const breaks = row.breaks.map(b => `${b.start || ''}～${b.end || ''}`).join(' / ');
                const workTime = (row.in && row.out) ? calcDuration(row.in, row.out, row.breaks) : '';
                csv += `${date},${row.in || ''},${row.out || ''},"${breaks}","${workTime}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'kintai.csv';
            a.click();
        }

        render();
    </script>
</body>

</html>