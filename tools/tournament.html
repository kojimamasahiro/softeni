<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トーナメント管理</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }

    .match-result {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 5px;
    }

    .score-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      margin: 5px 0;
    }

    .player-score-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-name {
      width: 200px;
      font-weight: bold;
    }

    .score-set {
      display: flex;
      gap: 4px;
    }

    .vs-text {
      font-weight: bold;
      margin: 4px 0;
      align-self: center;
    }

    .score-button {
      padding: 4px 8px;
      font-size: 14px;
    }

    .score-button.selected {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    .winner {
      color: #d32f2f;
      font-weight: bold;
    }

    #nextRoundBtn {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
    }

    h2 {
      margin-top: 40px;
    }

    #jsonOutput {
      width: 100%;
      height: 200px;
      margin-top: 30px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
  </style>
</head>

<body>

  <h1>トーナメント試合管理</h1>
  <div style="margin-bottom: 10px;">
    <label for="roundInput">ラウンド番号を変更:</label>
    <input type="number" id="roundInput" min="1" value="1" style="width: 60px;">
    <button id="setRoundBtn">変更</button>
  </div>
  <label>
    <input type="checkbox" id="roundNameToggle" checked>
    決勝・準決勝の表記にする
  </label>
  <button onclick="onClickGenerate()">出力</button>

  <script>
    function onClickGenerate() {
      updateJsonOutput();
    }
  </script>

  <div id="roundName"></div>
  <div id="matches"></div>
  <button id="nextRoundBtn">次のラウンドへ</button>

  <h2>最終JSON出力</h2>
  <textarea id="jsonOutput" readonly style="height: 800px;"></textarea>

  <script>
    // パッキン用ダミーペア
    const byePlayer = { id: "bye", name: "1回戦免除", information: [] };

    // プレイヤー情報（ペア名 + 各プレイヤーID）
    const initialPlayers =
[
{"id":36,"name":"中村・岡田（明治大学）","information":[{"lastName":"中村","firstName":"悠峰","team":"明治大学","playerId":null,"tempId":"悠峰_中村_明治大学"},{"lastName":"岡田","firstName":"侑也","team":"明治大学","playerId":null,"tempId":"侑也_岡田_明治大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":37,"name":"山岡・黒田（國學院大學）","information":[{"lastName":"山岡","firstName":"昂太郎","team":"國學院大學","playerId":null,"tempId":"昂太郎_山岡_國學院大學"},{"lastName":"黒田","firstName":"将希","team":"國學院大學","playerId":null,"tempId":"将希_黒田_國學院大學"}]},
{"id":38,"name":"望月・間宮（中央大学）","information":[{"lastName":"望月","firstName":"優吾","team":"中央大学","playerId":null,"tempId":"優吾_望月_中央大学"},{"lastName":"間宮","firstName":"青波","team":"中央大学","playerId":null,"tempId":"青波_間宮_中央大学"}]},
{"id":39,"name":"中田・丸井（創価大学）","information":[{"lastName":"中田","firstName":"颯太","team":"創価大学","playerId":null,"tempId":"颯太_中田_創価大学"},{"lastName":"丸井","firstName":"幸之介","team":"創価大学","playerId":null,"tempId":"幸之介_丸井_創価大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":40,"name":"水島・戸田（千葉商科大学）","information":[{"lastName":"水島","firstName":"虎樹","team":"千葉商科大学","playerId":null,"tempId":"虎樹_水島_千葉商科大学"},{"lastName":"戸田","firstName":"翔大","team":"千葉商科大学","playerId":null,"tempId":"翔大_戸田_千葉商科大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":41,"name":"萩原・後関（専修大学）","information":[{"lastName":"萩原","firstName":"陽介","team":"専修大学","playerId":null,"tempId":"陽介_萩原_専修大学"},{"lastName":"後関","firstName":"晴登","team":"専修大学","playerId":null,"tempId":"晴登_後関_専修大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":42,"name":"千葉・若林（立正大学）","information":[{"lastName":"千葉","firstName":"康平","team":"立正大学","playerId":null,"tempId":"康平_千葉_立正大学"},{"lastName":"若林","firstName":"綾夏","team":"立正大学","playerId":null,"tempId":"綾夏_若林_立正大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":43,"name":"山崎・保利（東海大学）","information":[{"lastName":"山崎","firstName":"周真","team":"東海大学","playerId":null,"tempId":"周真_山崎_東海大学"},{"lastName":"保利","firstName":"彰大","team":"東海大学","playerId":null,"tempId":"彰大_保利_東海大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":44,"name":"林・稲丸（日本体育大学）","information":[{"lastName":"林","firstName":"星汰","team":"日本体育大学","playerId":"hayashi-seita","tempId":"星汰_林_日本体育大学"},{"lastName":"稲丸","firstName":"獅道","team":"日本体育大学","playerId":"inamaru-shido","tempId":"獅道_稲丸_日本体育大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":45,"name":"相澤・渡邉（帝京大学）","information":[{"lastName":"相澤","firstName":"波月","team":"帝京大学","playerId":null,"tempId":"波月_相澤_帝京大学"},{"lastName":"渡邉","firstName":"柊羽","team":"帝京大学","playerId":null,"tempId":"柊羽_渡邉_帝京大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":46,"name":"田嶋・古谷（駿河台大学）","information":[{"lastName":"田嶋","firstName":"陸玖","team":"駿河台大学","playerId":null,"tempId":"陸玖_田嶋_駿河台大学"},{"lastName":"古谷","firstName":"一志","team":"駿河台大学","playerId":null,"tempId":"一志_古谷_駿河台大学"}]},
{"id":47,"name":"百澤・原田（東京経済大学）","information":[{"lastName":"百澤","firstName":"堅亮","team":"東京経済大学","playerId":null,"tempId":"堅亮_百澤_東京経済大学"},{"lastName":"原田","firstName":"隼輔","team":"東京経済大学","playerId":null,"tempId":"隼輔_原田_東京経済大学"}]},
{"id":48,"name":"高橋・原田（法政大学）","information":[{"lastName":"高橋","firstName":"輝","team":"法政大学","playerId":null,"tempId":"輝_高橋_法政大学"},{"lastName":"原田","firstName":"滉太","team":"法政大学","playerId":null,"tempId":"滉太_原田_法政大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":49,"name":"大家・鳥竹（東海大学）","information":[{"lastName":"大家","firstName":"健慎","team":"東海大学","playerId":null,"tempId":"健慎_大家_東海大学"},{"lastName":"鳥竹","firstName":"柊生","team":"東海大学","playerId":null,"tempId":"柊生_鳥竹_東海大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":50,"name":"二瓶・増子（東洋大学）","information":[{"lastName":"二瓶","firstName":"碧音","team":"東洋大学","playerId":null,"tempId":"碧音_二瓶_東洋大学"},{"lastName":"増子","firstName":"朝飛","team":"東洋大学","playerId":null,"tempId":"朝飛_増子_東洋大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":51,"name":"淺倉・池田（国士舘大学）","information":[{"lastName":"淺倉","firstName":"岳","team":"国士舘大学","playerId":null,"tempId":"岳_淺倉_国士舘大学"},{"lastName":"池田","firstName":"功佑","team":"国士舘大学","playerId":null,"tempId":"功佑_池田_国士舘大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":52,"name":"菅原・小林（慶應義塾大学）","information":[{"lastName":"菅原","firstName":"悠生","team":"慶應義塾大学","playerId":null,"tempId":"悠生_菅原_慶應義塾大学"},{"lastName":"小林","firstName":"武蔵","team":"慶應義塾大学","playerId":null,"tempId":"武蔵_小林_慶應義塾大学"}]},
{"id":53,"name":"古山・野々村（城西大学）","information":[{"lastName":"古山","firstName":"瑛仁","team":"城西大学","playerId":null,"tempId":"瑛仁_古山_城西大学"},{"lastName":"野々村","firstName":"羚凰","team":"城西大学","playerId":null,"tempId":"羚凰_野々村_城西大学"}]},
{"id":54,"name":"奥田・豊田（立教大学）","information":[{"lastName":"奥田","firstName":"叶汰","team":"立教大学","playerId":null,"tempId":"叶汰_奥田_立教大学"},{"lastName":"豊田","firstName":"祐冴","team":"立教大学","playerId":null,"tempId":"祐冴_豊田_立教大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},

{"id":"bye","name":"1回戦免除","information":[]},
{"id":56,"name":"高須賀・杉山（早稲田大学）","information":[{"lastName":"高須賀","firstName":"祥也","team":"早稲田大学","playerId":null,"tempId":"祥也_高須賀_早稲田大学"},{"lastName":"杉山","firstName":"賢太","team":"早稲田大学","playerId":null,"tempId":"賢太_杉山_早稲田大学"}]},
{"id":57,"name":"酒井・奥山（東洋大学）","information":[{"lastName":"酒井","firstName":"蒼空","team":"東洋大学","playerId":null,"tempId":"蒼空_酒井_東洋大学"},{"lastName":"奥山","firstName":"海征","team":"東洋大学","playerId":null,"tempId":"海征_奥山_東洋大学"}]},
{"id":58,"name":"吉野・渡邉（駿河台大学）","information":[{"lastName":"吉野","firstName":"志洸","team":"駿河台大学","playerId":null,"tempId":"志洸_吉野_駿河台大学"},{"lastName":"渡邉","firstName":"そら","team":"駿河台大学","playerId":null,"tempId":"そら_渡邉_駿河台大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":59,"name":"菊池・金山（城西大学）","information":[{"lastName":"菊池","firstName":"愛叶","team":"城西大学","playerId":null,"tempId":"愛叶_菊池_城西大学"},{"lastName":"金山","firstName":"翔太","team":"城西大学","playerId":null,"tempId":"翔太_金山_城西大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":60,"name":"野中・若林（中央大学）","information":[{"lastName":"野中","firstName":"翔太","team":"中央大学","playerId":null,"tempId":"翔太_野中_中央大学"},{"lastName":"若林","firstName":"宝来","team":"中央大学","playerId":null,"tempId":"宝来_若林_中央大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":61,"name":"沼田・藤田（東海大学）","information":[{"lastName":"沼田","firstName":"青緯","team":"東海大学","playerId":null,"tempId":"青緯_沼田_東海大学"},{"lastName":"藤田","firstName":"颯汰","team":"東海大学","playerId":null,"tempId":"颯汰_藤田_東海大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":62,"name":"岡本・岡田（日本体育大学）","information":[{"lastName":"岡本","firstName":"颯舞","team":"日本体育大学","playerId":"okamoto-souma","tempId":"颯舞_岡本_日本体育大学"},{"lastName":"岡田","firstName":"弥真斗","team":"日本体育大学","playerId":"okada-masato","tempId":"弥真斗_岡田_日本体育大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":63,"name":"渡邉・松田（東京経済大学）","information":[{"lastName":"渡邉","firstName":"優心","team":"東京経済大学","playerId":null,"tempId":"優心_渡邉_東京経済大学"},{"lastName":"松田","firstName":"知大","team":"東京経済大学","playerId":null,"tempId":"知大_松田_東京経済大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":64,"name":"間庭・佐藤（明治大学）","information":[{"lastName":"間庭","firstName":"賢人","team":"明治大学","playerId":null,"tempId":"賢人_間庭_明治大学"},{"lastName":"佐藤","firstName":"亜結夢","team":"明治大学","playerId":null,"tempId":"亜結夢_佐藤_明治大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":65,"name":"根津・高木（東海大学）","information":[{"lastName":"根津","firstName":"煌大","team":"東海大学","playerId":null,"tempId":"煌大_根津_東海大学"},{"lastName":"高木","firstName":"琉惺","team":"東海大学","playerId":null,"tempId":"琉惺_高木_東海大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":66,"name":"金子・木村（専修大学）","information":[{"lastName":"金子","firstName":"流音","team":"専修大学","playerId":null,"tempId":"流音_金子_専修大学"},{"lastName":"木村","firstName":"春陽","team":"専修大学","playerId":null,"tempId":"春陽_木村_専修大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":67,"name":"南・五味（立教大学）","information":[{"lastName":"南","firstName":"亮斗","team":"立教大学","playerId":null,"tempId":"亮斗_南_立教大学"},{"lastName":"五味","firstName":"知晃","team":"立教大学","playerId":null,"tempId":"知晃_五味_立教大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":68,"name":"中込・成田（流通経済大学）","information":[{"lastName":"中込","firstName":"琉星","team":"流通経済大学","playerId":null,"tempId":"琉星_中込_流通経済大学"},{"lastName":"成田","firstName":"和広","team":"流通経済大学","playerId":null,"tempId":"和広_成田_流通経済大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":69,"name":"岡田・永澤（東洋大学）","information":[{"lastName":"岡田","firstName":"楓真","team":"東洋大学","playerId":null,"tempId":"楓真_岡田_東洋大学"},{"lastName":"永澤","firstName":"志輝","team":"東洋大学","playerId":null,"tempId":"志輝_永澤_東洋大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":70,"name":"渡辺・松田（日本体育大学）","information":[{"lastName":"渡辺","firstName":"康介","team":"日本体育大学","playerId":"watanabe-kousuke","tempId":"康介_渡辺_日本体育大学"},{"lastName":"松田","firstName":"義明","team":"日本体育大学","playerId":"matsuda-yoshiaki","tempId":"義明_松田_日本体育大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":71,"name":"森川・野本（法政大学）","information":[{"lastName":"森川","firstName":"亮介","team":"法政大学","playerId":null,"tempId":"亮介_森川_法政大学"},{"lastName":"野本","firstName":"凌生","team":"法政大学","playerId":null,"tempId":"凌生_野本_法政大学"}]},
{"id":"bye","name":"1回戦免除","information":[]}
]
    // [
    // {"id":18,"name":"髙田・松本（早稲田大学）","information":[{"lastName":"髙田","firstName":"淳貴","team":"早稲田大学","playerId":null,"tempId":"淳貴_髙田_早稲田大学"},{"lastName":"松本","firstName":"翔太","team":"早稲田大学","playerId":null,"tempId":"翔太_松本_早稲田大学"}]},
    // {"id":55,"name":"小池・村田（慶應義塾大学）","information":[{"lastName":"小池","firstName":"賀久","team":"慶應義塾大学","playerId":null,"tempId":"賀久_小池_慶應義塾大学"},{"lastName":"村田","firstName":"雅常","team":"慶應義塾大学","playerId":null,"tempId":"雅常_村田_慶應義塾大学"}]},
    // ]
      ;


    let roundMatches = Array.from({ length: initialPlayers.length / 2 }, (_, i) => ({
      p1: initialPlayers[i * 2],
      p2: initialPlayers[i * 2 + 1],
      scores: { p1: null, p2: null },
      winner: null,
    }));

    // const initialPlayers = [
    //   { id: "1", name: "田中・佐藤", information: [{ playerId: "p1" }, { playerId: "p2" }] },
    //   byePlayer,

    //   { id: "2", name: "鈴木・山田", information: [{ playerId: "p3" }, { playerId: "p4" }] },
    //   { id: "3", name: "高橋・伊藤", information: [{ playerId: "p5" }, { playerId: "p6" }] },

    //   { id: "4", name: "加藤・山口", information: [{ playerId: "p7" }, { playerId: "p8" }] },
    //   byePlayer,

    //   { id: "5", name: "中村・小林", information: [{ playerId: "p9" }, { playerId: "p10" }] },
    //   byePlayer,

    //   { id: "6", name: "渡辺・松本", information: [{ playerId: "p11" }, { playerId: "p12" }] },
    //   byePlayer,

    //   { id: "7", name: "山田・佐々木", information: [{ playerId: "p15" }, { playerId: "p16" }] },
    //   byePlayer,

    //   { id: "8", name: "井上・木村", information: [{ playerId: "p13" }, { playerId: "p14" }] },
    //   { id: "9", name: "吉田・山本", information: [{ playerId: "p17" }, { playerId: "p18" }] },

    //   byePlayer,
    //   { id: "10", name: "清水・中島", information: [{ playerId: "p19" }, { playerId: "p20" }] },
    // ];

    let roundHistory = [];
    let roundNumber = 1;

    // ラウンド名（日本語）
    function getRoundName(numMatches, roundNumer = roundNumber) {
      if (document.getElementById("roundNameToggle").checked && numMatches <= 4) {
        // 決勝・準決勝・準々決勝の特別名
        if (numMatches === 1) return "決勝";
        if (numMatches === 2) return "準決勝";
        if (numMatches === 4) return "準々決勝";
      } else {
        // それ以外は「n回戦」
        return `${roundNumer}回戦`;
      }
    }

    // 勝者名取得（ペア名表示）
    function getWinnerName(match) {
      if (!match.winner) return "未定";
      if (match.winner === "bye") return "パッキン";
      if (match.winner === match.p1.id) return match.p1.name;
      if (match.winner === match.p2.id) return match.p2.name;
      return "未定";
    }

    // スコアボタンの選択状態更新
    function updateScoreButtons(matchIndex) {
      const match = roundMatches[matchIndex];

      ["p1", "p2"].forEach(player => {
        let selectedScore = match.scores[player];

        // 未設定なら0にセット（表示上の選択状態として）
        if (selectedScore === null || selectedScore === undefined) {
          selectedScore = 5;
          match.scores[player] = 5;
        }

        const scoreButtons = document.querySelectorAll(
          `.score-button[data-match="${matchIndex}"][data-player="${player}"]`
        );

        scoreButtons.forEach(btn => {
          const score = Number(btn.dataset.score);
          btn.classList.toggle("selected", score === selectedScore);

          // パッキン戦はスコアボタン非表示にする
          if (match.p1.id === "bye" || match.p2.id === "bye") {
            btn.style.display = "none";
          } else {
            btn.style.display = "inline-block";
          }
        });
      });
    }

    // スコア設定と勝者判定（パッキン戦は自動判定）
    function setScore(matchIndex, player, score) {
      const match = roundMatches[matchIndex];
      if (match.p1.id === "bye") {
        match.winner = match.p2.id;
      } else if (match.p2.id === "bye") {
        match.winner = match.p1.id;
      } else {
        match.scores[player] = score;

        if (match.scores.p1 !== null && match.scores.p2 !== null) {
          if (match.scores.p1 > match.scores.p2) {
            match.winner = match.p1.id;
          } else if (match.scores.p2 > match.scores.p1) {
            match.winner = match.p2.id;
          } else {
            match.winner = null; // 引き分けは未決定
          }
        } else {
          match.winner = null;
        }
      }

      document.getElementById(`winner-${matchIndex}`).textContent = getWinnerName(match);
      updateScoreButtons(matchIndex);
      updateJsonOutput();
    }

    // パッキン戦は初期勝者決定しておく
    function autoDecideByeMatches() {
      roundMatches.forEach((match, i) => {
        if (match.p1.id === "bye") {
          match.winner = match.p2.id;
          match.scores = { p1: 0, p2: 5 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        } else if (match.p2.id === "bye") {
          match.winner = match.p1.id;
          match.scores = { p1: 5, p2: 0 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        }
      });
    }

    // 試合表示
    function displayMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";
      document.getElementById("roundName").textContent = `第${roundNumber}ラウンド：${getRoundName(roundMatches.length, roundNumber)}`;
      document.getElementById("roundInput").value = roundNumber;

      roundMatches.forEach((match, i) => {
        const div = document.createElement("div");
        div.className = "match-result";

        div.innerHTML = `
  <strong>試合 ${i + 1}</strong><br/>
  <div class="score-container">
    <div class="player-score-row">
      <span class="player-name">${match.p1.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p1" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
    <div class="vs-text">vs</div>
    <div class="player-score-row">
      <span class="player-name">${match.p2.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p2" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
  </div>
  <div>勝者：<span id="winner-${i}" class="winner">${getWinnerName(match)}</span></div>
`;


        matchesDiv.appendChild(div);
      });

      // スコアボタンにイベント付与
      document.querySelectorAll(".score-button").forEach(btn => {
        btn.addEventListener("click", e => {
          const matchIndex = Number(e.target.dataset.match);
          const player = e.target.dataset.player;
          const score = Number(e.target.dataset.score);
          setScore(matchIndex, player, score);
        });
      });

      // パッキン戦のスコアボタンは非表示にし、勝者自動決定
      autoDecideByeMatches();
      roundMatches.forEach((_, i) => updateScoreButtons(i));
      updateJsonOutput();
    }

    document.getElementById("setRoundBtn").addEventListener("click", () => {
      const newRound = parseInt(document.getElementById("roundInput").value);
      if (isNaN(newRound) || newRound < 1) {
        alert("1以上のラウンド番号を入力してください。");
        return;
      }
      roundNumber = newRound;
      displayMatches();
    });

    // 次のラウンドへ進む処理
    document.getElementById("nextRoundBtn").addEventListener("click", () => {
      if (roundMatches.some(match => !match.winner)) {
        alert("すべての試合の勝者を決めてください。");
        return;
      }

      // 現ラウンドを履歴に保存
      roundHistory.push({
        round: getRoundName(roundMatches.length, roundNumber),
        matches: JSON.parse(JSON.stringify(roundMatches))
      });

      // 勝者だけ抽出
      const winners = roundMatches.map(m => initialPlayers.find(p => p.id === m.winner));

      // 優勝判定
      if (winners.length === 1) {
        updateJsonOutput();
        return;
      }

      // 次ラウンド準備
      roundNumber++;
      roundMatches = [];
      for (let i = 0; i < winners.length; i += 2) {
        roundMatches.push({
          p1: winners[i],
          p2: winners[i + 1],
          scores: { p1: null, p2: null },
          winner: null
        });
      }

      displayMatches();
    });

    // JSON出力更新
    function updateJsonOutput() {
      const useRoundNames = document.getElementById("roundNameToggle").checked;
      const output = {};

      const roundCount = roundHistory.length;
      const resultPairs = new Set();

      // ラウンド名変換
      function getRoundLabel(index, totalRounds, useRoundNames) {
        const roundNames = {
          1: "決勝",
          2: "準決勝",
          3: "準々決勝"
        };
        const reverseIndex = totalRounds - index;
        if (useRoundNames && roundNames[reverseIndex]) {
          return roundNames[reverseIndex];
        }
        return `${index + 1}回戦`;
      }

      const roundRankings = {};
      roundRankings[roundCount - 1] = { winner: "優勝", loser: "準優勝" };
      if (roundCount - 2 >= 0) roundRankings[roundCount - 2] = { loser: "ベスト4" };
      if (roundCount - 3 >= 0) roundRankings[roundCount - 3] = { loser: "ベスト8" };

      const getPairKey = (info) => info?.information?.map(p => p.playerId).sort().join("-");
      const getPairArray = (info) => info?.information?.map(p => p.playerId).sort();
      const isValidPair = (arr) => arr.every(id => id !== null && id !== undefined);

      // resultSummary を先に生成（必要な場合）
      if (useRoundNames) {
        const resultSummary = [];

        for (let i = roundCount - 1; i >= 0; i--) {
          const matches = roundHistory[i].matches;
          const ranking = roundRankings[i];
          if (!ranking) continue;

          for (const match of matches) {
            if (!match.p1 || !match.p2 || !match.winner) continue;

            const p1Key = getPairKey(match.p1);
            const p2Key = getPairKey(match.p2);
            const p1Array = getPairArray(match.p1);
            const p2Array = getPairArray(match.p2);
            if (!p1Key || !p2Key) continue;

            const isP1Winner = match.winner === match.p1.id;
            const winnerKey = isP1Winner ? p1Key : p2Key;
            const loserKey = isP1Winner ? p2Key : p1Key;
            const winnerArray = isP1Winner ? p1Array : p2Array;
            const loserArray = isP1Winner ? p2Array : p1Array;

            if (ranking.winner && !resultPairs.has(winnerKey) && isValidPair(winnerArray)) {
              resultSummary.push({
                pair: winnerArray,
                finalRound: ranking.winner,
              });
              resultPairs.add(winnerKey);
            }
            if (ranking.loser && !resultPairs.has(loserKey) && isValidPair(loserArray)) {
              resultSummary.push({
                pair: loserArray,
                finalRound: ranking.loser,
              });
              resultPairs.add(loserKey);
            }
          }
        }

        output.resultSummary = resultSummary;
      }

      // matches を後から生成
      output.matches = [];

      for (let i = 0; i < roundCount; i++) {
        const matches = roundHistory[i].matches;
        const roundLabel = roundHistory[i].round;

        for (const match of matches) {
          const matchWithRound = structuredClone(match);
          matchWithRound.round = roundLabel;

          const splitMatches = splitMatchByPlayerIds(matchWithRound);
          output.matches.push(...splitMatches);
        }
      }

      document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
    }

    function splitMatchByPlayerIds(match) {

      if (match.p1.id === 'bye' || match.p2.id === 'bye') {
        return [];
      }

      const results = [];

      const p1Ids = match.p1.information.map(info => info.playerId || info.tempId);
      const p2Ids = match.p2.information.map(info => info.playerId || info.tempId);

      const p1IsValid = p1Ids.every(id => id != null);
      const p2IsValid = p2Ids.every(id => id != null);

      const p1IsWinner = (match.winner === match.p1.id);

      const p1Score = String(match.scores.p1);
      const p2Score = String(match.scores.p2);

      if (p1IsValid) {
        results.push({
          round: match.round,
          pair: p1Ids,
          opponents: match.p2.information,
          result: p1IsWinner ? "win" : "lose",
          games: {
            won: p1Score,
            lost: p2Score
          }
        });
      }

      if (p2IsValid) {
        results.push({
          round: match.round,
          pair: p2Ids,
          opponents: match.p1.information,
          result: p1IsWinner ? "lose" : "win",
          games: {
            won: p2Score,
            lost: p1Score,
          }
        });
      }

      return results;
    }

    function getRoundLabel(index, totalRounds) {
      const roundNames = {
        1: "決勝",
        2: "準決勝",
        3: "準々決勝"
      };
      const reverseIndex = totalRounds - index;
      if (roundNames[reverseIndex]) return roundNames[reverseIndex];
      return `${index + 1}回`;
    }

    // 初期表示
    displayMatches();
  </script>

</body>

</html>