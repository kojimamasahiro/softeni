<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トーナメント管理</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }

    .match-result {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 5px;
    }

    .score-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      margin: 5px 0;
    }

    .player-score-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-name {
      width: 200px;
      font-weight: bold;
    }

    .score-set {
      display: flex;
      gap: 4px;
    }

    .vs-text {
      font-weight: bold;
      margin: 4px 0;
      align-self: center;
    }

    .score-button {
      padding: 4px 8px;
      font-size: 14px;
    }

    .score-button.selected {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    .winner {
      color: #d32f2f;
      font-weight: bold;
    }

    #nextRoundBtn {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
    }

    h2 {
      margin-top: 40px;
    }

    #jsonOutput {
      width: 100%;
      height: 200px;
      margin-top: 30px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
  </style>
</head>

<body>

  <h1>トーナメント試合管理</h1>
  <div style="margin-bottom: 10px;">
    <label for="roundInput">ラウンド番号を変更:</label>
    <input type="number" id="roundInput" min="1" value="1" style="width: 60px;">
    <button id="setRoundBtn">変更</button>
  </div>
  <label>
    <input type="checkbox" id="roundNameToggle" checked>
    決勝・準決勝の表記にする
  </label>
  <button onclick="onClickGenerate()">出力</button>

  <script>
    function onClickGenerate() {
      updateJsonOutput();
    }
  </script>

  <div id="roundName"></div>
  <div id="matches"></div>
  <button id="nextRoundBtn">次のラウンドへ</button>

  <h2>最終JSON出力</h2>
  <textarea id="jsonOutput" readonly style="height: 800px;"></textarea>

  <script>
    // パッキン用ダミーペア
    const byePlayer = { id: "bye", name: "1回戦免除", information: [] };

    // プレイヤー情報（ペア名 + 各プレイヤーID）
    const initialPlayers =
[
{"id":19,"name":"長野・金澤（中央大学）","information":[{"lastName":"長野","firstName":"瑛寿","team":"中央大学","playerId":null,"tempId":"瑛寿_長野_中央大学"},{"lastName":"金澤","firstName":"慧","team":"中央大学","playerId":null,"tempId":"慧_金澤_中央大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":20,"name":"佐々木・那須（東京経済大学）","information":[{"lastName":"佐々木","firstName":"禅斗","team":"東京経済大学","playerId":null,"tempId":"禅斗_佐々木_東京経済大学"},{"lastName":"那須","firstName":"瑛太","team":"東京経済大学","playerId":null,"tempId":"瑛太_那須_東京経済大学"}]},
{"id":21,"name":"中村・金﨑（隆之介）","information":[{"lastName":"中村","firstName":"陽","team":"隆之介","playerId":null,"tempId":"陽_中村_隆之介"},{"lastName":"金﨑","firstName":"隆之介","team":"隆之介","playerId":null,"tempId":"隆之介_金﨑_隆之介"}]},
{"id":22,"name":"高松・近藤（城西大学）","information":[{"lastName":"高松","firstName":"直","team":"城西大学","playerId":null,"tempId":"直_高松_城西大学"},{"lastName":"近藤","firstName":"奏太","team":"城西大学","playerId":null,"tempId":"奏太_近藤_城西大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":23,"name":"團野・早川（立教大学）","information":[{"lastName":"團野","firstName":"佑紀","team":"立教大学","playerId":null,"tempId":"佑紀_團野_立教大学"},{"lastName":"早川","firstName":"悠佑","team":"立教大学","playerId":null,"tempId":"悠佑_早川_立教大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":24,"name":"稲見・高坂（日本体育大学）","information":[{"lastName":"稲見","firstName":"虎佑","team":"日本体育大学","playerId":"inami-koyu","tempId":"inami-koyu"},{"lastName":"高坂","firstName":"侑希","team":"日本体育大学","playerId":"takasaka-yuki","tempId":"takasaka-yuki"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":25,"name":"平岩・渡（早稲田大学）","information":[{"lastName":"平岩","firstName":"稜将","team":"早稲田大学","playerId":null,"tempId":"稜将_平岩_早稲田大学"},{"lastName":"渡","firstName":"健博","team":"早稲田大学","playerId":null,"tempId":"健博_渡_早稲田大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":26,"name":"伊達崎・日高（千葉商科大学）","information":[{"lastName":"伊達崎","firstName":"洸毅","team":"千葉商科大学","playerId":null,"tempId":"洸毅_伊達崎_千葉商科大学"},{"lastName":"日高","firstName":"大成","team":"千葉商科大学","playerId":null,"tempId":"大成_日高_千葉商科大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":27,"name":"鬼塚・板橋（東洋大学）","information":[{"lastName":"鬼塚","firstName":"一成","team":"東洋大学","playerId":null,"tempId":"一成_鬼塚_東洋大学"},{"lastName":"板橋","firstName":"慧星","team":"東洋大学","playerId":null,"tempId":"慧星_板橋_東洋大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":28,"name":"伊関・福島（日本体育大学）","information":[{"lastName":"伊関","firstName":"悠","team":"日本体育大学","playerId":"iseki-yu","tempId":"悠_伊関_日本体育大学"},{"lastName":"福島","firstName":"涼","team":"日本体育大学","playerId":"fukushima-ryo","tempId":"涼_福島_日本体育大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":29,"name":"岩田・真下（帝京大学）","information":[{"lastName":"岩田","firstName":"蒼科","team":"帝京大学","playerId":null,"tempId":"蒼科_岩田_帝京大学"},{"lastName":"真下","firstName":"朔稲","team":"帝京大学","playerId":null,"tempId":"朔稲_真下_帝京大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":30,"name":"榎・毛利（日本大学）","information":[{"lastName":"榎","firstName":"祐希人","team":"日本大学","playerId":null,"tempId":"祐希人_榎_日本大学"},{"lastName":"毛利","firstName":"快生","team":"日本大学","playerId":null,"tempId":"快生_毛利_日本大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":31,"name":"米川・中原（明治大学）","information":[{"lastName":"米川","firstName":"雅翔","team":"明治大学","playerId":null,"tempId":"雅翔_米川_明治大学"},{"lastName":"中原","firstName":"壮琉","team":"明治大学","playerId":null,"tempId":"壮琉_中原_明治大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":32,"name":"久住・松元（法政大学）","information":[{"lastName":"久住","firstName":"颯希","team":"法政大学","playerId":null,"tempId":"颯希_久住_法政大学"},{"lastName":"松元","firstName":"海翔","team":"法政大学","playerId":null,"tempId":"海翔_松元_法政大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":33,"name":"小川・巴（立正大学）","information":[{"lastName":"小川","firstName":"哲平","team":"立正大学","playerId":null,"tempId":"哲平_小川_立正大学"},{"lastName":"巴","firstName":"亮太","team":"立正大学","playerId":null,"tempId":"亮太_巴_立正大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":34,"name":"石田・栗木（専修大学）","information":[{"lastName":"石田","firstName":"恭介","team":"専修大学","playerId":null,"tempId":"恭介_石田_専修大学"},{"lastName":"栗木","firstName":"志優","team":"専修大学","playerId":null,"tempId":"志優_栗木_専修大学"}]},
{"id":"bye","name":"1回戦免除","information":[]},
{"id":35,"name":"大和・金井（國學院大學）","information":[{"lastName":"大和","firstName":"昌生","team":"國學院大學","playerId":null,"tempId":"昌生_大和_國學院大學"},{"lastName":"金井","firstName":"亮太","team":"國學院大學","playerId":null,"tempId":"亮太_金井_國學院大學"}]},
{"id":"bye","name":"1回戦免除","information":[]}
]

      ;
    // [
    // {"id":18,"name":"髙田・松本（早稲田大学）","information":[{"lastName":"髙田","firstName":"淳貴","team":"早稲田大学","playerId":null,"tempId":"淳貴_髙田_早稲田大学"},{"lastName":"松本","firstName":"翔太","team":"早稲田大学","playerId":null,"tempId":"翔太_松本_早稲田大学"}]}
    // {"id":35,"name":"大和・金井（國學院大學）","information":[{"lastName":"大和","firstName":"昌生","team":"國學院大學","playerId":null,"tempId":"昌生_大和_國學院大學"},{"lastName":"金井","firstName":"亮太","team":"國學院大學","playerId":null,"tempId":"亮太_金井_國學院大學"}]},
    // ]

    let roundMatches = Array.from({ length: initialPlayers.length / 2 }, (_, i) => ({
      p1: initialPlayers[i * 2],
      p2: initialPlayers[i * 2 + 1],
      scores: { p1: null, p2: null },
      winner: null,
    }));

    // const initialPlayers = [
    //   { id: "1", name: "田中・佐藤", information: [{ playerId: "p1" }, { playerId: "p2" }] },
    //   byePlayer,

    //   { id: "2", name: "鈴木・山田", information: [{ playerId: "p3" }, { playerId: "p4" }] },
    //   { id: "3", name: "高橋・伊藤", information: [{ playerId: "p5" }, { playerId: "p6" }] },

    //   { id: "4", name: "加藤・山口", information: [{ playerId: "p7" }, { playerId: "p8" }] },
    //   byePlayer,

    //   { id: "5", name: "中村・小林", information: [{ playerId: "p9" }, { playerId: "p10" }] },
    //   byePlayer,

    //   { id: "6", name: "渡辺・松本", information: [{ playerId: "p11" }, { playerId: "p12" }] },
    //   byePlayer,

    //   { id: "7", name: "山田・佐々木", information: [{ playerId: "p15" }, { playerId: "p16" }] },
    //   byePlayer,

    //   { id: "8", name: "井上・木村", information: [{ playerId: "p13" }, { playerId: "p14" }] },
    //   { id: "9", name: "吉田・山本", information: [{ playerId: "p17" }, { playerId: "p18" }] },

    //   byePlayer,
    //   { id: "10", name: "清水・中島", information: [{ playerId: "p19" }, { playerId: "p20" }] },
    // ];

    let roundHistory = [];
    let roundNumber = 1;

    // ラウンド名（日本語）
    function getRoundName(numMatches, roundNumer = roundNumber) {
      if (document.getElementById("roundNameToggle").checked && numMatches <= 4) {
        // 決勝・準決勝・準々決勝の特別名
        if (numMatches === 1) return "決勝";
        if (numMatches === 2) return "準決勝";
        if (numMatches === 4) return "準々決勝";
      } else {
        // それ以外は「n回戦」
        return `${roundNumer}回戦`;
      }
    }

    // 勝者名取得（ペア名表示）
    function getWinnerName(match) {
      if (!match.winner) return "未定";
      if (match.winner === "bye") return "パッキン";
      if (match.winner === match.p1.id) return match.p1.name;
      if (match.winner === match.p2.id) return match.p2.name;
      return "未定";
    }

    // スコアボタンの選択状態更新
    function updateScoreButtons(matchIndex) {
      const match = roundMatches[matchIndex];

      ["p1", "p2"].forEach(player => {
        let selectedScore = match.scores[player];

        // 未設定なら0にセット（表示上の選択状態として）
        if (selectedScore === null || selectedScore === undefined) {
          selectedScore = 5;
          match.scores[player] = 5;
        }

        const scoreButtons = document.querySelectorAll(
          `.score-button[data-match="${matchIndex}"][data-player="${player}"]`
        );

        scoreButtons.forEach(btn => {
          const score = Number(btn.dataset.score);
          btn.classList.toggle("selected", score === selectedScore);

          // パッキン戦はスコアボタン非表示にする
          if (match.p1.id === "bye" || match.p2.id === "bye") {
            btn.style.display = "none";
          } else {
            btn.style.display = "inline-block";
          }
        });
      });
    }

    // スコア設定と勝者判定（パッキン戦は自動判定）
    function setScore(matchIndex, player, score) {
      const match = roundMatches[matchIndex];
      if (match.p1.id === "bye") {
        match.winner = match.p2.id;
      } else if (match.p2.id === "bye") {
        match.winner = match.p1.id;
      } else {
        match.scores[player] = score;

        if (match.scores.p1 !== null && match.scores.p2 !== null) {
          if (match.scores.p1 > match.scores.p2) {
            match.winner = match.p1.id;
          } else if (match.scores.p2 > match.scores.p1) {
            match.winner = match.p2.id;
          } else {
            match.winner = null; // 引き分けは未決定
          }
        } else {
          match.winner = null;
        }
      }

      document.getElementById(`winner-${matchIndex}`).textContent = getWinnerName(match);
      updateScoreButtons(matchIndex);
      updateJsonOutput();
    }

    // パッキン戦は初期勝者決定しておく
    function autoDecideByeMatches() {
      roundMatches.forEach((match, i) => {
        if (match.p1.id === "bye") {
          match.winner = match.p2.id;
          match.scores = { p1: 0, p2: 5 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        } else if (match.p2.id === "bye") {
          match.winner = match.p1.id;
          match.scores = { p1: 5, p2: 0 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        }
      });
    }

    // 試合表示
    function displayMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";
      document.getElementById("roundName").textContent = `第${roundNumber}ラウンド：${getRoundName(roundMatches.length, roundNumber)}`;
      document.getElementById("roundInput").value = roundNumber;

      roundMatches.forEach((match, i) => {
        const div = document.createElement("div");
        div.className = "match-result";

        div.innerHTML = `
  <strong>試合 ${i + 1}</strong><br/>
  <div class="score-container">
    <div class="player-score-row">
      <span class="player-name">${match.p1.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p1" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
    <div class="vs-text">vs</div>
    <div class="player-score-row">
      <span class="player-name">${match.p2.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p2" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
  </div>
  <div>勝者：<span id="winner-${i}" class="winner">${getWinnerName(match)}</span></div>
`;


        matchesDiv.appendChild(div);
      });

      // スコアボタンにイベント付与
      document.querySelectorAll(".score-button").forEach(btn => {
        btn.addEventListener("click", e => {
          const matchIndex = Number(e.target.dataset.match);
          const player = e.target.dataset.player;
          const score = Number(e.target.dataset.score);
          setScore(matchIndex, player, score);
        });
      });

      // パッキン戦のスコアボタンは非表示にし、勝者自動決定
      autoDecideByeMatches();
      roundMatches.forEach((_, i) => updateScoreButtons(i));
      updateJsonOutput();
    }

    document.getElementById("setRoundBtn").addEventListener("click", () => {
      const newRound = parseInt(document.getElementById("roundInput").value);
      if (isNaN(newRound) || newRound < 1) {
        alert("1以上のラウンド番号を入力してください。");
        return;
      }
      roundNumber = newRound;
      displayMatches();
    });

    // 次のラウンドへ進む処理
    document.getElementById("nextRoundBtn").addEventListener("click", () => {
      if (roundMatches.some(match => !match.winner)) {
        alert("すべての試合の勝者を決めてください。");
        return;
      }

      // 現ラウンドを履歴に保存
      roundHistory.push({
        round: getRoundName(roundMatches.length, roundNumber),
        matches: JSON.parse(JSON.stringify(roundMatches))
      });

      // 勝者だけ抽出
      const winners = roundMatches.map(m => initialPlayers.find(p => p.id === m.winner));

      // 優勝判定
      if (winners.length === 1) {
        updateJsonOutput();
        return;
      }

      // 次ラウンド準備
      roundNumber++;
      roundMatches = [];
      for (let i = 0; i < winners.length; i += 2) {
        roundMatches.push({
          p1: winners[i],
          p2: winners[i + 1],
          scores: { p1: null, p2: null },
          winner: null
        });
      }

      displayMatches();
    });

    // JSON出力更新
    function updateJsonOutput() {
      const useRoundNames = document.getElementById("roundNameToggle").checked;
      const output = {};

      const roundCount = roundHistory.length;
      const resultPairs = new Set();

      // ラウンド名変換
      function getRoundLabel(index, totalRounds, useRoundNames) {
        const roundNames = {
          1: "決勝",
          2: "準決勝",
          3: "準々決勝"
        };
        const reverseIndex = totalRounds - index;
        if (useRoundNames && roundNames[reverseIndex]) {
          return roundNames[reverseIndex];
        }
        return `${index + 1}回戦`;
      }

      const roundRankings = {};
      roundRankings[roundCount - 1] = { winner: "優勝", loser: "準優勝" };
      if (roundCount - 2 >= 0) roundRankings[roundCount - 2] = { loser: "ベスト4" };
      if (roundCount - 3 >= 0) roundRankings[roundCount - 3] = { loser: "ベスト8" };

      const getPairKey = (info) => info?.information?.map(p => p.playerId).sort().join("-");
      const getPairArray = (info) => info?.information?.map(p => p.playerId).sort();
      const isValidPair = (arr) => arr.every(id => id !== null && id !== undefined);

      // resultSummary を先に生成（必要な場合）
      if (useRoundNames) {
        const resultSummary = [];

        for (let i = roundCount - 1; i >= 0; i--) {
          const matches = roundHistory[i].matches;
          const ranking = roundRankings[i];
          if (!ranking) continue;

          for (const match of matches) {
            if (!match.p1 || !match.p2 || !match.winner) continue;

            const p1Key = getPairKey(match.p1);
            const p2Key = getPairKey(match.p2);
            const p1Array = getPairArray(match.p1);
            const p2Array = getPairArray(match.p2);
            if (!p1Key || !p2Key) continue;

            const isP1Winner = match.winner === match.p1.id;
            const winnerKey = isP1Winner ? p1Key : p2Key;
            const loserKey = isP1Winner ? p2Key : p1Key;
            const winnerArray = isP1Winner ? p1Array : p2Array;
            const loserArray = isP1Winner ? p2Array : p1Array;

            if (ranking.winner && !resultPairs.has(winnerKey) && isValidPair(winnerArray)) {
              resultSummary.push({
                pair: winnerArray,
                finalRound: ranking.winner,
              });
              resultPairs.add(winnerKey);
            }
            if (ranking.loser && !resultPairs.has(loserKey) && isValidPair(loserArray)) {
              resultSummary.push({
                pair: loserArray,
                finalRound: ranking.loser,
              });
              resultPairs.add(loserKey);
            }
          }
        }

        output.resultSummary = resultSummary;
      }

      // matches を後から生成
      output.matches = [];

      for (let i = 0; i < roundCount; i++) {
        const matches = roundHistory[i].matches;
        const roundLabel = roundHistory[i].round;

        for (const match of matches) {
          const matchWithRound = structuredClone(match);
          matchWithRound.round = roundLabel;

          const splitMatches = splitMatchByPlayerIds(matchWithRound);
          output.matches.push(...splitMatches);
        }
      }

      document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
    }

    function splitMatchByPlayerIds(match) {

      if (match.p1.id === 'bye' || match.p2.id === 'bye') {
        return [];
      }

      const results = [];

      const p1Ids = match.p1.information.map(info => info.playerId || info.tempId);
      const p2Ids = match.p2.information.map(info => info.playerId || info.tempId);

      const p1IsValid = p1Ids.every(id => id != null);
      const p2IsValid = p2Ids.every(id => id != null);

      const p1IsWinner = (match.winner === match.p1.id);

      const p1Score = String(match.scores.p1);
      const p2Score = String(match.scores.p2);

      if (p1IsValid) {
        results.push({
          round: match.round,
          pair: p1Ids,
          opponents: match.p2.information,
          result: p1IsWinner ? "win" : "lose",
          games: {
            won: p1Score,
            lost: p2Score
          }
        });
      }

      if (p2IsValid) {
        results.push({
          round: match.round,
          pair: p2Ids,
          opponents: match.p1.information,
          result: p1IsWinner ? "lose" : "win",
          games: {
            won: p2Score,
            lost: p1Score,
          }
        });
      }

      return results;
    }

    function getRoundLabel(index, totalRounds) {
      const roundNames = {
        1: "決勝",
        2: "準決勝",
        3: "準々決勝"
      };
      const reverseIndex = totalRounds - index;
      if (roundNames[reverseIndex]) return roundNames[reverseIndex];
      return `${index + 1}回`;
    }

    // 初期表示
    displayMatches();
  </script>

</body>

</html>