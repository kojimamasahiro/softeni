<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トーナメント管理</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }

    .match-result {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 5px;
    }

    .score-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      margin: 5px 0;
    }

    .player-score-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-name {
      width: 200px;
      font-weight: bold;
    }

    .score-set {
      display: flex;
      gap: 4px;
    }

    .vs-text {
      font-weight: bold;
      margin: 4px 0;
      align-self: center;
    }

    .score-button {
      padding: 4px 8px;
      font-size: 14px;
    }

    .score-button.selected {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    .winner {
      color: #d32f2f;
      font-weight: bold;
    }

    #nextRoundBtn {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
    }

    h2 {
      margin-top: 40px;
    }

    #jsonOutput {
      width: 100%;
      height: 200px;
      margin-top: 30px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
  </style>
</head>

<body>

  <h1>トーナメント試合管理</h1>
  <div style="margin-bottom: 10px;">
    <label for="roundInput">ラウンド番号を変更:</label>
    <input type="number" id="roundInput" min="1" value="1" style="width: 60px;">
    <button id="setRoundBtn">変更</button>
  </div>
  <label>
    <input type="checkbox" id="roundNameToggle" checked>
    決勝・準決勝の表記にする
  </label>
  <button onclick="onClickGenerate()">出力</button>

  <script>
    function onClickGenerate() {
      updateJsonOutput(roundHistory);
    }
  </script>

  <div id="roundName"></div>
  <div id="matches"></div>
  <button id="nextRoundBtn">次のラウンドへ</button>

  <h2>最終JSON出力</h2>
  <textarea id="jsonOutput" readonly style="height: 800px;"></textarea>

  <script>
    // パッキン用ダミーペア
    const byePlayer = { id: "bye", name: "1回戦免除", information: [] };

    // プレイヤー情報（ペア名 + 各プレイヤーID）
    const initialPlayers =
      [
        { "id": 1, "name": "片岡・黒坂（日本体育大学）", "information": [{ "lastName": "片岡", "firstName": "暁紀", "team": "日本体育大学", "playerId": "kataoka-aki", "tempId": "kataoka-aki" }, { "lastName": "黒坂", "firstName": "卓矢", "team": "日本体育大学", "playerId": "kurosaka-takuya", "tempId": "kurosaka-takuya" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 2, "name": "青木・キング（立教大学）", "information": [{ "lastName": "青木", "firstName": "颯汰", "team": "立教大学", "playerId": null, "tempId": "颯汰_青木_立教大学" }, { "lastName": "キング", "firstName": "ルイス", "team": "立教大学", "playerId": null, "tempId": "ルイス_キング_立教大学" }] },
        { "id": 3, "name": "熊木・上田（法政大学）", "information": [{ "lastName": "熊木", "firstName": "暖", "team": "法政大学", "playerId": null, "tempId": "暖_熊木_法政大学" }, { "lastName": "上田", "firstName": "唯仁", "team": "法政大学", "playerId": null, "tempId": "唯仁_上田_法政大学" }] },
        { "id": 4, "name": "高野・高梨（東海大学）", "information": [{ "lastName": "高野", "firstName": "伊織", "team": "東海大学", "playerId": null, "tempId": "伊織_高野_東海大学" }, { "lastName": "高梨", "firstName": "佑紀人", "team": "東海大学", "playerId": null, "tempId": "佑紀人_高梨_東海大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 5, "name": "火山・吉野（帝京大学）", "information": [{ "lastName": "火山", "firstName": "優希", "team": "帝京大学", "playerId": null, "tempId": "優希_火山_帝京大学" }, { "lastName": "吉野", "firstName": "碧", "team": "帝京大学", "playerId": null, "tempId": "碧_吉野_帝京大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 6, "name": "宮本・深井（城西大学）", "information": [{ "lastName": "宮本", "firstName": "涼平", "team": "城西大学", "playerId": null, "tempId": "涼平_宮本_城西大学" }, { "lastName": "深井", "firstName": "葉太郎", "team": "城西大学", "playerId": null, "tempId": "葉太郎_深井_城西大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 7, "name": "古賀・町田（東洋大学）", "information": [{ "lastName": "古賀", "firstName": "太平", "team": "東洋大学", "playerId": null, "tempId": "太平_古賀_東洋大学" }, { "lastName": "町田", "firstName": "開", "team": "東洋大学", "playerId": null, "tempId": "開_町田_東洋大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 8, "name": "諸橋・玉木（白鴎大学）", "information": [{ "lastName": "諸橋", "firstName": "巧翔", "team": "白鴎大学", "playerId": null, "tempId": "巧翔_諸橋_白鴎大学" }, { "lastName": "玉木", "firstName": "歩", "team": "白鴎大学", "playerId": null, "tempId": "歩_玉木_白鴎大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 9, "name": "前岡・榊原（駿河台大学）", "information": [{ "lastName": "前岡", "firstName": "和亜", "team": "駿河台大学", "playerId": null, "tempId": "和亜_前岡_駿河台大学" }, { "lastName": "榊原", "firstName": "志門", "team": "駿河台大学", "playerId": null, "tempId": "志門_榊原_駿河台大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 10, "name": "梶山・長谷川（國學院大學）", "information": [{ "lastName": "梶山", "firstName": "成", "team": "國學院大學", "playerId": null, "tempId": "成_梶山_國學院大學" }, { "lastName": "長谷川", "firstName": "大輝", "team": "國學院大學", "playerId": null, "tempId": "大輝_長谷川_國學院大學" }] },
        { "id": 11, "name": "岡田・伊藤（大東文化大学）", "information": [{ "lastName": "岡田", "firstName": "侑披", "team": "大東文化大学", "playerId": null, "tempId": "侑披_岡田_大東文化大学" }, { "lastName": "伊藤", "firstName": "秀也", "team": "大東文化大学", "playerId": null, "tempId": "秀也_伊藤_大東文化大学" }] },
        { "id": 12, "name": "灰佐・後藤（慶應義塾大学）", "information": [{ "lastName": "灰佐", "firstName": "賢人", "team": "慶應義塾大学", "playerId": null, "tempId": "賢人_灰佐_慶應義塾大学" }, { "lastName": "後藤", "firstName": "煌", "team": "慶應義塾大学", "playerId": null, "tempId": "煌_後藤_慶應義塾大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 13, "name": "須澤・茶木（日本体育大学）", "information": [{ "lastName": "須澤", "firstName": "心晴", "team": "日本体育大学", "playerId": "suzawa-koharu", "tempId": "suzawa-koharu" }, { "lastName": "茶木", "firstName": "將巨", "team": "日本体育大学", "playerId": "chaki-masataka", "tempId": "chaki-masataka" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 14, "name": "松村・市村（東海大学）", "information": [{ "lastName": "松村", "firstName": "遼太郎", "team": "東海大学", "playerId": null, "tempId": "遼太郎_松村_東海大学" }, { "lastName": "市村", "firstName": "大地", "team": "東海大学", "playerId": null, "tempId": "大地_市村_東海大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 15, "name": "千葉・小野（東京経済大学）", "information": [{ "lastName": "千葉", "firstName": "琉翔", "team": "東京経済大学", "playerId": null, "tempId": "琉翔_千葉_東京経済大学" }, { "lastName": "小野", "firstName": "武蔵", "team": "東京経済大学", "playerId": null, "tempId": "武蔵_小野_東京経済大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] },
        { "id": 16, "name": "相澤・宮脇（順天堂大学）", "information": [{ "lastName": "相澤", "firstName": "明喜", "team": "順天堂大学", "playerId": null, "tempId": "明喜_相澤_順天堂大学" }, { "lastName": "宮脇", "firstName": "光由", "team": "順天堂大学", "playerId": null, "tempId": "光由_宮脇_順天堂大学" }] },
        { "id": 17, "name": "行方・坂入（千葉商科大学）", "information": [{ "lastName": "行方", "firstName": "聖流", "team": "千葉商科大学", "playerId": null, "tempId": "聖流_行方_千葉商科大学" }, { "lastName": "坂入", "firstName": "寿紀", "team": "千葉商科大学", "playerId": null, "tempId": "寿紀_坂入_千葉商科大学" }] },
        { "id": 18, "name": "髙田・松本（早稲田大学）", "information": [{ "lastName": "髙田", "firstName": "淳貴", "team": "早稲田大学", "playerId": null, "tempId": "淳貴_髙田_早稲田大学" }, { "lastName": "松本", "firstName": "翔太", "team": "早稲田大学", "playerId": null, "tempId": "翔太_松本_早稲田大学" }] },
        { "id": "bye", "name": "1回戦免除", "information": [] }
      ]

      ;
    // [
    // {"id":1,"name":"片岡・黒坂（日本体育大学）","information":[{"lastName":"片岡","firstName":"暁紀","team":"日本体育大学","playerId":"kataoka-aki","tempId":"kataoka-aki"},{"lastName":"黒坂","firstName":"卓矢","team":"日本体育大学","playerId":"kurosaka-takuya","tempId":"kurosaka-takuya"}]},
    // {"id":18,"name":"髙田・松本（早稲田大学）","information":[{"lastName":"髙田","firstName":"淳貴","team":"早稲田大学","playerId":null,"tempId":"淳貴_髙田_早稲田大学"},{"lastName":"松本","firstName":"翔太","team":"早稲田大学","playerId":null,"tempId":"翔太_松本_早稲田大学"}]}
    // ]

    let roundMatches = Array.from({ length: initialPlayers.length / 2 }, (_, i) => ({
      p1: initialPlayers[i * 2],
      p2: initialPlayers[i * 2 + 1],
      scores: { p1: null, p2: null },
      winner: null,
    }));

    // const initialPlayers = [
    //   { id: "1", name: "田中・佐藤", information: [{ playerId: "p1" }, { playerId: "p2" }] },
    //   byePlayer,

    //   { id: "2", name: "鈴木・山田", information: [{ playerId: "p3" }, { playerId: "p4" }] },
    //   { id: "3", name: "高橋・伊藤", information: [{ playerId: "p5" }, { playerId: "p6" }] },

    //   { id: "4", name: "加藤・山口", information: [{ playerId: "p7" }, { playerId: "p8" }] },
    //   byePlayer,

    //   { id: "5", name: "中村・小林", information: [{ playerId: "p9" }, { playerId: "p10" }] },
    //   byePlayer,

    //   { id: "6", name: "渡辺・松本", information: [{ playerId: "p11" }, { playerId: "p12" }] },
    //   byePlayer,

    //   { id: "7", name: "山田・佐々木", information: [{ playerId: "p15" }, { playerId: "p16" }] },
    //   byePlayer,

    //   { id: "8", name: "井上・木村", information: [{ playerId: "p13" }, { playerId: "p14" }] },
    //   { id: "9", name: "吉田・山本", information: [{ playerId: "p17" }, { playerId: "p18" }] },

    //   byePlayer,
    //   { id: "10", name: "清水・中島", information: [{ playerId: "p19" }, { playerId: "p20" }] },
    // ];

    let roundHistory = [];
    let roundNumber = 1;

    // ラウンド名（日本語）
    function getRoundName(numMatches, roundNumer = roundNumber) {
      switch (numMatches) {
        case 1: return "決勝";
        case 2: return "準決勝";
        case 4: return "準々決勝";
        default: return `${roundNumer}回戦`;
      }
    }

    // 勝者名取得（ペア名表示）
    function getWinnerName(match) {
      if (!match.winner) return "未定";
      if (match.winner === "bye") return "パッキン";
      if (match.winner === match.p1.id) return match.p1.name;
      if (match.winner === match.p2.id) return match.p2.name;
      return "未定";
    }

    // スコアボタンの選択状態更新
    function updateScoreButtons(matchIndex) {
      const match = roundMatches[matchIndex];

      ["p1", "p2"].forEach(player => {
        let selectedScore = match.scores[player];

        // 未設定なら0にセット（表示上の選択状態として）
        if (selectedScore === null || selectedScore === undefined) {
          selectedScore = 5;
          match.scores[player] = 5;
        }

        const scoreButtons = document.querySelectorAll(
          `.score-button[data-match="${matchIndex}"][data-player="${player}"]`
        );

        scoreButtons.forEach(btn => {
          const score = Number(btn.dataset.score);
          btn.classList.toggle("selected", score === selectedScore);

          // パッキン戦はスコアボタン非表示にする
          if (match.p1.id === "bye" || match.p2.id === "bye") {
            btn.style.display = "none";
          } else {
            btn.style.display = "inline-block";
          }
        });
      });
    }

    // スコア設定と勝者判定（パッキン戦は自動判定）
    function setScore(matchIndex, player, score) {
      const match = roundMatches[matchIndex];
      if (match.p1.id === "bye") {
        match.winner = match.p2.id;
      } else if (match.p2.id === "bye") {
        match.winner = match.p1.id;
      } else {
        match.scores[player] = score;

        if (match.scores.p1 !== null && match.scores.p2 !== null) {
          if (match.scores.p1 > match.scores.p2) {
            match.winner = match.p1.id;
          } else if (match.scores.p2 > match.scores.p1) {
            match.winner = match.p2.id;
          } else {
            match.winner = null; // 引き分けは未決定
          }
        } else {
          match.winner = null;
        }
      }

      document.getElementById(`winner-${matchIndex}`).textContent = getWinnerName(match);
      updateScoreButtons(matchIndex);
      updateJsonOutput(roundHistory.map(round => round.matches));
    }

    // パッキン戦は初期勝者決定しておく
    function autoDecideByeMatches() {
      roundMatches.forEach((match, i) => {
        if (match.p1.id === "bye") {
          match.winner = match.p2.id;
          match.scores = { p1: 0, p2: 5 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        } else if (match.p2.id === "bye") {
          match.winner = match.p1.id;
          match.scores = { p1: 5, p2: 0 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        }
      });
    }

    // 試合表示
    function displayMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";
      document.getElementById("roundName").textContent = `第${roundNumber}ラウンド：${getRoundName(roundMatches.length, roundNumber)}`;
      document.getElementById("roundInput").value = roundNumber;

      roundMatches.forEach((match, i) => {
        const div = document.createElement("div");
        div.className = "match-result";

        div.innerHTML = `
  <strong>試合 ${i + 1}</strong><br/>
  <div class="score-container">
    <div class="player-score-row">
      <span class="player-name">${match.p1.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p1" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
    <div class="vs-text">vs</div>
    <div class="player-score-row">
      <span class="player-name">${match.p2.name}</span>
      <div class="score-set">
        ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p2" data-score="${s}">${s}</button>`
        ).join("")}
      </div>
    </div>
  </div>
  <div>勝者：<span id="winner-${i}" class="winner">${getWinnerName(match)}</span></div>
`;


        matchesDiv.appendChild(div);
      });

      // スコアボタンにイベント付与
      document.querySelectorAll(".score-button").forEach(btn => {
        btn.addEventListener("click", e => {
          const matchIndex = Number(e.target.dataset.match);
          const player = e.target.dataset.player;
          const score = Number(e.target.dataset.score);
          setScore(matchIndex, player, score);
        });
      });

      // パッキン戦のスコアボタンは非表示にし、勝者自動決定
      autoDecideByeMatches();
      roundMatches.forEach((_, i) => updateScoreButtons(i));
      updateJsonOutput(roundHistory.map(round => round.matches));
    }

    document.getElementById("setRoundBtn").addEventListener("click", () => {
      const newRound = parseInt(document.getElementById("roundInput").value);
      if (isNaN(newRound) || newRound < 1) {
        alert("1以上のラウンド番号を入力してください。");
        return;
      }
      roundNumber = newRound;
      displayMatches();
    });

    // 次のラウンドへ進む処理
    document.getElementById("nextRoundBtn").addEventListener("click", () => {
      if (roundMatches.some(match => !match.winner)) {
        alert("すべての試合の勝者を決めてください。");
        return;
      }

      // 現ラウンドを履歴に保存
      roundHistory.push({
        round: getRoundName(roundMatches.length, roundNumber),
        matches: JSON.parse(JSON.stringify(roundMatches))
      });

      // 勝者だけ抽出
      const winners = roundMatches.map(m => initialPlayers.find(p => p.id === m.winner));

      // 優勝判定
      if (winners.length === 1) {
        updateJsonOutput(roundHistory.map(round => round.matches));
        return;
      }

      // 次ラウンド準備
      roundNumber++;
      roundMatches = [];
      for (let i = 0; i < winners.length; i += 2) {
        roundMatches.push({
          p1: winners[i],
          p2: winners[i + 1],
          scores: { p1: null, p2: null },
          winner: null
        });
      }

      displayMatches();
    });

    // JSON出力更新
    function updateJsonOutput(roundHistory) {
      const useRoundNames = document.getElementById("roundNameToggle").checked;
      const output = {};

      const roundCount = roundHistory.length;
      const resultPairs = new Set();

      // ラウンド名変換
      function getRoundLabel(index, totalRounds, useRoundNames) {
        const roundNames = {
          1: "決勝",
          2: "準決勝",
          3: "準々決勝"
        };
        const reverseIndex = totalRounds - index;
        if (useRoundNames && roundNames[reverseIndex]) {
          return roundNames[reverseIndex];
        }
        return `${index}回戦`;
      }

      const roundRankings = {};
      roundRankings[roundCount - 1] = { winner: "優勝", loser: "準優勝" };
      if (roundCount - 2 >= 0) roundRankings[roundCount - 2] = { loser: "ベスト4" };
      if (roundCount - 3 >= 0) roundRankings[roundCount - 3] = { loser: "ベスト8" };

      const getPairKey = (info) => info?.information?.map(p => p.playerId).sort().join("-");
      const getPairArray = (info) => info?.information?.map(p => p.playerId).sort();
      const isValidPair = (arr) => arr.every(id => id !== null && id !== undefined);

      // resultSummary を先に生成（必要な場合）
      if (useRoundNames) {
        const resultSummary = [];

        for (let i = roundCount - 1; i >= 0; i--) {
          const matches = roundHistory[i];
          const ranking = roundRankings[i];
          if (!ranking) continue;

          for (const match of matches) {
            if (!match.p1 || !match.p2 || !match.winner) continue;

            const p1Key = getPairKey(match.p1);
            const p2Key = getPairKey(match.p2);
            const p1Array = getPairArray(match.p1);
            const p2Array = getPairArray(match.p2);
            if (!p1Key || !p2Key) continue;

            const isP1Winner = match.winner === match.p1.id;
            const winnerKey = isP1Winner ? p1Key : p2Key;
            const loserKey = isP1Winner ? p2Key : p1Key;
            const winnerArray = isP1Winner ? p1Array : p2Array;
            const loserArray = isP1Winner ? p2Array : p1Array;

            if (ranking.winner && !resultPairs.has(winnerKey) && isValidPair(winnerArray)) {
              resultSummary.push({
                pair: winnerArray,
                finalRound: ranking.winner,
              });
              resultPairs.add(winnerKey);
            }
            if (ranking.loser && !resultPairs.has(loserKey) && isValidPair(loserArray)) {
              resultSummary.push({
                pair: loserArray,
                finalRound: ranking.loser,
              });
              resultPairs.add(loserKey);
            }
          }
        }

        output.resultSummary = resultSummary;
      }

      // matches を後から生成
      output.matches = [];

      for (let i = 0; i < roundCount; i++) {
        const matches = roundHistory[i];
        const roundLabel = getRoundLabel(i + roundNumber - 1, roundCount, useRoundNames);

        for (const match of matches) {
          const matchWithRound = structuredClone(match);
          matchWithRound.round = roundLabel;

          const splitMatches = splitMatchByPlayerIds(matchWithRound);
          output.matches.push(...splitMatches);
        }
      }

      document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
    }

    function splitMatchByPlayerIds(match) {

      if (match.p1.id === 'bye' || match.p2.id === 'bye') {
        return [];
      }

      const results = [];

      const p1Ids = match.p1.information.map(info => info.playerId || info.tempId);
      const p2Ids = match.p2.information.map(info => info.playerId || info.tempId);

      const p1IsValid = p1Ids.every(id => id != null);
      const p2IsValid = p2Ids.every(id => id != null);

      const p1IsWinner = (match.winner === match.p1.id);

      const p1Score = String(match.scores.p1);
      const p2Score = String(match.scores.p2);

      if (p1IsValid) {
        results.push({
          round: match.round,
          pair: p1Ids,
          opponents: match.p2.information,
          result: p1IsWinner ? "win" : "lose",
          games: {
            won: p1IsWinner ? p1Score : p2Score,
            lost: p1IsWinner ? p2Score : p1Score,
          }
        });
      }

      if (p2IsValid) {
        results.push({
          round: match.round,
          pair: p2Ids,
          opponents: match.p1.information,
          result: p1IsWinner ? "lose" : "win",
          games: {
            won: p1IsWinner ? p2Score : p1Score,
            lost: p1IsWinner ? p1Score : p2Score,
          }
        });
      }

      return results;
    }

    function getRoundLabel(index, totalRounds) {
      const roundNames = {
        1: "決勝",
        2: "準決勝",
        3: "準々決勝"
      };
      const reverseIndex = totalRounds - index;
      if (roundNames[reverseIndex]) return roundNames[reverseIndex];
      return `${index + 1}回`;
    }

    // 初期表示
    displayMatches();
  </script>

</body>

</html>