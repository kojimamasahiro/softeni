<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トーナメント管理</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 10px;
    }

    .match-result {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 5px;
    }

    .score-button {
      margin: 0 2px;
      padding: 5px 10px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      user-select: none;
      font-size: 16px;
    }

    .score-button.selected {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    .winner {
      color: #d32f2f;
      font-weight: bold;
    }

    #nextRoundBtn {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
    }

    h2 {
      margin-top: 40px;
    }

    #jsonOutput {
      width: 100%;
      height: 200px;
      margin-top: 30px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
  </style>
</head>

<body>

  <h1>トーナメント試合管理</h1>
  <div style="margin-bottom: 10px;">
    <label for="roundInput">ラウンド番号を変更:</label>
    <input type="number" id="roundInput" min="1" value="1" style="width: 60px;">
    <button id="setRoundBtn">変更</button>
  </div>

  <div id="roundName"></div>
  <div id="matches"></div>
  <button id="nextRoundBtn">次のラウンドへ</button>

  <h2>最終JSON出力</h2>
  <textarea id="jsonOutput" readonly></textarea>

  <script>
    // パッキン用ダミーペア
    const byePlayer = { id: "bye", name: "パッキン", information: [] };

    // プレイヤー情報（ペア名 + 各プレイヤーID）
    const initialPlayers = [
      { id: "1", name: "田中・佐藤", information: [{ playerId: "p1" }, { playerId: "p2" }] },
      { id: "2", name: "鈴木・山田", information: [{ playerId: "p3" }, { playerId: "p4" }] },
      { id: "3", name: "高橋・伊藤", information: [{ playerId: "p5" }, { playerId: "p6" }] },
      { id: "4", name: "加藤・山口", information: [{ playerId: "p7" }, { playerId: "p8" }] },
      { id: "5", name: "中村・小林", information: [{ playerId: "p9" }, { playerId: "p10" }] },
      { id: "6", name: "渡辺・松本", information: [{ playerId: "p11" }, { playerId: "p12" }] },
      { id: "7", name: "山田・佐々木", information: [{ playerId: "p15" }, { playerId: "p16" }] },
      { id: "8", name: "井上・木村", information: [{ playerId: "p13" }, { playerId: "p14" }] },
      { id: "9", name: "吉田・山本", information: [{ playerId: "p17" }, { playerId: "p18" }] },
      { id: "10", name: "清水・中島", information: [{ playerId: "p19" }, { playerId: "p20" }] },
      { id: "11", name: "林・池田", information: [{ playerId: "p21" }, { playerId: "p22" }] },
      { id: "12", name: "山崎・藤田", information: [{ playerId: "p23" }, { playerId: "p24" }] },
      { id: "13", name: "岡田・石井", information: [{ playerId: "p25" }, { playerId: "p26" }] },
      { id: "14", name: "森・松田", information: [{ playerId: "p27" }, { playerId: "p28" }] },
      { id: "15", name: "福田・西村", information: [{ playerId: "p29" }, { playerId: "p30" }] },
      { id: "16", name: "遠藤・近藤", information: [{ playerId: "p31" }, { playerId: "p32" }] }
    ];

    // 初期ラウンドの試合ペア（4ペアから2試合）
    let roundMatches = [
      { p1: initialPlayers[0], p2: initialPlayers[1], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[2], p2: initialPlayers[3], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[4], p2: initialPlayers[5], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[6], p2: initialPlayers[7], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[8], p2: initialPlayers[9], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[10], p2: initialPlayers[11], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[12], p2: initialPlayers[13], scores: { p1: null, p2: null }, winner: null },
      { p1: initialPlayers[14], p2: initialPlayers[15], scores: { p1: null, p2: null }, winner: null }
    ];

    let roundHistory = [];
    let roundNumber = 1;

    // ラウンド名（日本語）
    function getRoundName(numMatches, roundNumer = roundNumber) {
      switch (numMatches) {
        case 1: return "決勝";
        case 2: return "準決勝";
        case 4: return "準々決勝";
        default: return `${roundNumer}回戦`;
      }
    }

    // 勝者名取得（ペア名表示）
    function getWinnerName(match) {
      if (!match.winner) return "未定";
      if (match.winner === "bye") return "パッキン";
      if (match.winner === match.p1.id) return match.p1.name;
      if (match.winner === match.p2.id) return match.p2.name;
      return "未定";
    }

    // スコアボタンの選択状態更新
    function updateScoreButtons(matchIndex) {
      const match = roundMatches[matchIndex];

      ["p1", "p2"].forEach(player => {
        const selectedScore = match.scores[player];
        const scoreButtons = document.querySelectorAll(
          `.score-button[data-match="${matchIndex}"][data-player="${player}"]`
        );

        scoreButtons.forEach((btn, i) => {
          const score = Number(btn.dataset.score);
          btn.classList.toggle("selected", score === selectedScore);

          // パッキン戦はスコアボタン非表示にする
          if (match.p1.id === "bye" || match.p2.id === "bye") {
            btn.style.display = "none";
          } else {
            btn.style.display = "inline-block";
          }
        });
      });
    }


    // スコア設定と勝者判定（パッキン戦は自動判定）
    function setScore(matchIndex, player, score) {
      const match = roundMatches[matchIndex];
      if (match.p1.id === "bye") {
        match.winner = match.p2.id;
      } else if (match.p2.id === "bye") {
        match.winner = match.p1.id;
      } else {
        match.scores[player] = score;

        if (match.scores.p1 !== null && match.scores.p2 !== null) {
          if (match.scores.p1 > match.scores.p2) {
            match.winner = match.p1.id;
          } else if (match.scores.p2 > match.scores.p1) {
            match.winner = match.p2.id;
          } else {
            match.winner = null; // 引き分けは未決定
          }
        } else {
          match.winner = null;
        }
      }

      document.getElementById(`winner-${matchIndex}`).textContent = getWinnerName(match);
      updateScoreButtons(matchIndex);
      updateJsonOutput();
    }

    // パッキン戦は初期勝者決定しておく
    function autoDecideByeMatches() {
      roundMatches.forEach((match, i) => {
        if (match.p1.id === "bye") {
          match.winner = match.p2.id;
          match.scores = { p1: 0, p2: 5 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        } else if (match.p2.id === "bye") {
          match.winner = match.p1.id;
          match.scores = { p1: 5, p2: 0 };
          document.getElementById(`winner-${i}`) && (document.getElementById(`winner-${i}`).textContent = getWinnerName(match));
        }
      });
    }

    // 試合表示
    function displayMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";
      document.getElementById("roundName").textContent = `第${roundNumber}ラウンド：${getRoundName(roundMatches.length, roundNumber)}`;
      document.getElementById("roundInput").value = roundNumber;

      roundMatches.forEach((match, i) => {
        const div = document.createElement("div");
        div.className = "match-result";

        div.innerHTML = `
          <strong>試合 ${i + 1}</strong>：${match.p1.name} vs ${match.p2.name}<br/>
          <div>
            ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p1" data-score="${s}">${s}</button>`
        ).join("")}
            &nbsp;vs&nbsp;
            ${[0, 1, 2, 3, 4, 5].map(
          s => `<button class="score-button" data-match="${i}" data-player="p2" data-score="${s}">${s}</button>`
        ).join("")}
          </div>
          <div>勝者：<span id="winner-${i}" class="winner">${getWinnerName(match)}</span></div>
        `;

        matchesDiv.appendChild(div);
      });

      // スコアボタンにイベント付与
      document.querySelectorAll(".score-button").forEach(btn => {
        btn.addEventListener("click", e => {
          const matchIndex = Number(e.target.dataset.match);
          const player = e.target.dataset.player;
          const score = Number(e.target.dataset.score);
          setScore(matchIndex, player, score);
        });
      });

      // パッキン戦のスコアボタンは非表示にし、勝者自動決定
      autoDecideByeMatches();
      roundMatches.forEach((_, i) => updateScoreButtons(i));
      updateJsonOutput();
    }
    document.getElementById("setRoundBtn").addEventListener("click", () => {
      const newRound = parseInt(document.getElementById("roundInput").value);
      if (isNaN(newRound) || newRound < 1) {
        alert("1以上のラウンド番号を入力してください。");
        return;
      }
      roundNumber = newRound;
      displayMatches();
    });

    // 次のラウンドへ進む処理
    document.getElementById("nextRoundBtn").addEventListener("click", () => {
      if (roundMatches.some(match => !match.winner)) {
        alert("すべての試合の勝者を決めてください。");
        return;
      }

      // 現ラウンドを履歴に保存
      roundHistory.push({
        round: getRoundName(roundMatches.length, roundNumber),
        matches: JSON.parse(JSON.stringify(roundMatches))
      });

      // 勝者だけ抽出
      const winners = roundMatches.map(m => initialPlayers.find(p => p.id === m.winner));

      // 優勝判定
      if (winners.length === 1) {
        alert(`優勝は ${winners[0].name} です！`);
        document.getElementById("nextRoundBtn").disabled = true;
        updateJsonOutput();
        return;
      }

      // 次ラウンド準備
      roundNumber++;
      roundMatches = [];
      for (let i = 0; i < winners.length; i += 2) {
        roundMatches.push({
          p1: winners[i],
          p2: winners[i + 1],
          scores: { p1: null, p2: null },
          winner: null
        });
      }

      displayMatches();
    });

    // JSON出力更新

    function updateJsonOutput() {
      const output = {
        matches: roundHistory.flatMap(round =>
          round.matches
            .filter(m => m.p1.id !== "bye" && m.p2.id !== "bye") // bye戦を除外
            .map(m => ({
              round: round.round,
              p1: { id: m.p1.id, name: m.p1.name, information: m.p1.information },
              p2: { id: m.p2.id, name: m.p2.name, information: m.p2.information },
              scores: m.scores
            }))
        )
      };

      document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
    }


    // 初期表示
    displayMatches();
  </script>

</body>

</html>